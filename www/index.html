<!doctype html>
<html><head>
	<title>Network Sketchpad</title>
	<meta charset="utf-8">
	<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
	<link rel="manifest" href="site.webmanifest">
	<style>

body {
	text-align: center;
	background: #DFDFDF;
	margin: 0;
	padding: 0;
	font: 14px/18px 'Lucida Grande', 'Segoe UI', sans-serif;
	overflow: hidden;
}

h1 {
	font: bold italic 24px Georgia, serif;
	margin: 0;
	position: absolute;
	top: 20px;
	left: 20px;
	z-index: 10;
	background: rgba(223, 223, 223, 0.9);
	padding: 8px 12px;
	border-radius: 8px;
	box-shadow: 0 2px 15px rgba(0,0,0,0.15);
	border: 1px solid rgba(0,0,0,0.1);
}

canvas {
	display: block;
	background: #f5f3e8; /* Fallback - overridden by GLOBAL_STYLE.canvasBackgroundColor in JS */
	border-radius: 0;
	-moz-border-radius: 0;
	margin: 0;
	position: absolute;
	top: 0;
	left: 0;
	transition: all 0.2s ease-in-out;
}

/* Drag and drop visual feedback */
canvas.drag-over {
	background: #e8f4f8;
	box-shadow: inset 0 0 20px rgba(52, 144, 220, 0.3);
	border: 3px dashed #3490dc;
	box-sizing: border-box;
}

a {
	color: black;
}



/* Action button box - top left */
#actionbuttonbox {
	position: absolute;
	top: 110px;
	left: 20px;
	background: rgba(223, 223, 223, 0.9);
	border-radius: 10px;
	padding: 20px;
	margin: 0;
	text-align: left;
	width: 180px;
	font-size: 12px;
	box-shadow: 0 2px 15px rgba(0,0,0,0.15);
	z-index: 10;
	border: 1px solid rgba(0,0,0,0.1);
	display: flex;
	flex-direction: column;
	gap: 8px;
}

/* Guide box - bottom left (modify existing div styles) */
#guibox {
	position: absolute;
	bottom: 20px;
	left: 20px;
	background: rgba(223, 223, 223, 0.9);
	border-radius: 10px;
	padding: 20px;
	margin: 0;
	text-align: left;
	max-width: 450px;
	font-size: 12px;
	box-shadow: 0 2px 15px rgba(0,0,0,0.15);
	z-index: 10;
	border: 1px solid rgba(0,0,0,0.1);
}

.primary-button {
	background: #9aad6b;
	color: white;
	border: none;
	padding: 10px 16px;
	border-radius: 5px;
	cursor: pointer;
	font-size: 12px;
	font-family: inherit;
	transition: background-color 0.2s;
}

.primary-button:hover {
	background: #7a8854;
}

.danger-button {
	background: #a67c52;
	color: white;
	border: none;
	padding: 10px 16px;
	border-radius: 5px;
	cursor: pointer;
	font-size: 12px;
	font-family: inherit;
	transition: background-color 0.2s;
}

.danger-button:hover {
	background: #8b6640;
}

.file-button {
	background: #9aad6b;
	color: white;
	display: inline-block;
	text-align: center;
	text-decoration: none;
}

.file-button:hover {
	background: #7a8854;
}

/* Update author credit styling since it's now inside guibox */
#guibox .author-credit {
	position: static;
	background: none;
	padding: 0;
	border-radius: 0;
	font-size: 12px;
	margin: 15px 0 0 0;
}

/* File Explorer Styles */

/* File list empty state */
#file-list-empty-state {
	font-style: italic;
}

#refresh-files-btn:hover {
	background: #f5f5f5;
}

#save-as-btn:hover:not(:disabled) {
	background: rgba(200, 200, 200, 0.9);
}

#save-as-btn:disabled {
	background: #cccccc;
	cursor: not-allowed;
}

.file-item {
	padding: 6px 10px;
	border-bottom: 1px solid #f0f0f0;
	cursor: pointer;
	font-size: 11px;
	transition: background-color 0.2s;
	display: flex;
	align-items: center;
	justify-content: space-between;
}

.file-item:hover {
	background: #f5f5f5;
}

.file-item.selected {
	background: #e3f2fd;
	border-left: 3px solid #2196f3;
}

.file-item:last-child {
	border-bottom: none;
}

.file-name {
	flex: 1;
	font-family: monospace;
	color: #333;
}

.file-actions {
	display: flex;
	gap: 4px;
}

.file-action-btn {
	background: none;
	border: 1px solid #ddd;
	padding: 2px 6px;
	border-radius: 3px;
	cursor: pointer;
	font-size: 9px;
	color: #666;
}

.file-action-btn:hover {
	background: #f0f0f0;
}

/* Controls toggle styling */
#controls-header:hover {
	background-color: rgba(0, 0, 0, 0.05);
	border-radius: 4px;
	padding: 2px 4px;
	margin: -2px -4px 6px -4px;
}

#controls-toggle {
	transition: transform 0.2s ease-in-out;
}

.error {
	display: block;
	color: red;
	font-size: 28px;
	line-height: 30px;
	padding: 30px;
}

p {
	margin: 30px 0;
	line-height: 20px;
}

.center {
	text-align: center;
}

  </style>
	<script src="built-fsm.js"></script>
	<script>

/*
 * base64.js - Base64 encoding and decoding functions
 *
 * See: http://developer.mozilla.org/en/docs/DOM:window.btoa
 *      http://developer.mozilla.org/en/docs/DOM:window.atob
 *
 * Copyright (c) 2007, David Lindquist <david.lindquist@gmail.com>
 * Released under the MIT license
 */

if (typeof btoa == 'undefined') {
    function btoa(str) {
        var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';
        var encoded = [];
        var c = 0;
        while (c < str.length) {
            var b0 = str.charCodeAt(c++);
            var b1 = str.charCodeAt(c++);
            var b2 = str.charCodeAt(c++);
            var buf = (b0 << 16) + ((b1 || 0) << 8) + (b2 || 0);
            var i0 = (buf & (63 << 18)) >> 18;
            var i1 = (buf & (63 << 12)) >> 12;
            var i2 = isNaN(b1) ? 64 : (buf & (63 << 6)) >> 6;
            var i3 = isNaN(b2) ? 64 : (buf & 63);
            encoded[encoded.length] = chars.charAt(i0);
            encoded[encoded.length] = chars.charAt(i1);
            encoded[encoded.length] = chars.charAt(i2);
            encoded[encoded.length] = chars.charAt(i3);
        }
        return encoded.join('');
    }
}

	</script>
</head><body>
	<!-- Removed Network Sketchpad header to hide top-left box -->
	<canvas id="canvas" width="800" height="600">
		<span class="error">Your browser does not support<br>the HTML5 &lt;canvas&gt; element</span>
	</canvas>
	
	<!-- Drag and drop overlay -->
	<div id="drag-overlay" style="
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: rgba(52, 144, 220, 0.1);
		display: none;
		justify-content: center;
		align-items: center;
		pointer-events: none;
		z-index: 1000;
	">
		<div style="
			background: rgba(255, 255, 255, 0.95);
			padding: 30px 40px;
			border-radius: 12px;
			box-shadow: 0 4px 20px rgba(0,0,0,0.2);
			border: 2px dashed #3490dc;
			text-align: center;
			font-family: inherit;
		">
			<div style="font-size: 24px; margin-bottom: 8px;">[Folder]</div>
			<div style="font-size: 16px; font-weight: bold; color: #3490dc; margin-bottom: 4px;">Drop JSON File Here</div>
			<div style="font-size: 12px; color: #666;">Release to load your sketch</div>
		</div>
	</div>
	
	<!-- Directory Selector Box (Box 1) - Simple directory selection -->
	<div id="directory-selector-box" onclick="chooseSketchDirectory()" title="Click to select a directory" style="
		position: absolute;
		top: 20px;
		left: 20px;
		background: rgba(223, 223, 223, 0.9);
		border-radius: 10px;
		padding: 15px;
		font-size: 16px;
		font-family: 'Lucida Grande', 'Segoe UI', sans-serif;
		box-shadow: 0 2px 15px rgba(0,0,0,0.15);
		border: 1px solid rgba(0,0,0,0.1);
		z-index: 9;
		display: block;
		cursor: pointer;
		transition: background-color 0.2s;
		text-align: center;
	" onmouseover="this.style.background='rgba(200, 200, 200, 0.9)'" onmouseout="this.style.background='rgba(223, 223, 223, 0.9)'">
		Select Directory
	</div>

	<!-- Separator slash between boxes -->
	<div id="box-separator" style="
		position: absolute;
		top: 20px;
		left: 180px;
		font-size: 24px;
		font-weight: bold;
		color: #666;
		z-index: 9;
		display: flex;
		align-items: center;
		height: 51px;
		pointer-events: none;
	">/</div>

	<!-- Save Box (Box 2) - File saving interface with collapsible state -->
	<!-- Collapsed state view (default) -->
	<div id="save-box" onclick="toggleSaveBox()" style="
		position: absolute;
		top: 20px;
		left: 200px;
		background: rgba(223, 223, 223, 0.9);
		border-radius: 10px;
		padding: 15px;
		margin: 0;
		text-align: center;
		width: auto;
		font-size: 16px;
		font-weight: bold;
		box-shadow: 0 2px 15px rgba(0,0,0,0.15);
		z-index: 10;
		border: 1px solid rgba(0,0,0,0.1);
		cursor: pointer;
		transition: background-color 0.2s;
	" onmouseover="this.style.background='rgba(200, 200, 200, 0.9)'" onmouseout="this.style.background='rgba(223, 223, 223, 0.9)'">
		<span id="collapsed-filename" style="font-size: 16px; color: #333;">sketch1.json</span>
	</div>
	
	<!-- Expanded state view -->
	<div id="save-box-expanded" style="
		position: absolute;
		top: 20px;
		left: 200px;
		background: rgba(223, 223, 223, 0.9);
		border-radius: 10px;
		padding: 15px;
		margin: 0;
		text-align: left;
		width: auto;
		font-size: 12px;
		box-shadow: 0 2px 15px rgba(0,0,0,0.15);
		z-index: 10;
		border: 1px solid rgba(0,0,0,0.1);
		display: none;
	">
			<!-- Collapse button at top -->
			<div style="margin-bottom: 10px;">
				<button id="collapse-save-box-btn" onclick="toggleSaveBox()" style="
					background: none;
					border: 1px solid #999;
					padding: 2px 6px;
					border-radius: 3px;
					cursor: pointer;
					font-size: 10px;
					color: #666;
					transition: background-color 0.2s;
					width: 100%;
					box-sizing: border-box;
				" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='none'">‚ñ≤</button>
			</div>
			
			<!-- Filename input -->
			<div style="margin-bottom: 12px;">
				<div style="display: flex; align-items: center; gap: 2px; font-size: 11px; font-family: inherit;">
					<input type="text" id="filenameInput" placeholder="sketch_name" value="sketch1"
						   oninput="syncCollapsedFilename()"
						   style="flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 3px; font-size: 11px; box-sizing: border-box; font-family: inherit; min-width: 80px;">
					<span style="color: #666;">.json</span>
				</div>
			</div>
			
			<!-- File list section -->
			<!-- Header with refresh button -->
			<div style="
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 8px;
				padding-bottom: 6px;
				border-bottom: 1px solid #ddd;
			">
				<span style="font-weight: bold; font-size: 11px; color: #333;">Files</span>
				<button id="refresh-files-btn" onclick="refreshFileList()" style="
					background: none;
					border: 1px solid #ccc;
					padding: 4px 8px;
					border-radius: 3px;
					cursor: pointer;
					font-size: 10px;
					font-family: inherit;
				">Refresh</button>
			</div>
			
			<!-- File list container -->
			<div id="file-list" style="
				max-height: 800px;
				overflow-y: auto;
				border: 1px solid #ddd;
				border-radius: 4px;
				background: white;
			">
				<!-- New button as first item in list -->
				<div onclick="handleNewSketch()" style="
					padding: 8px 10px;
					border-bottom: 1px solid #ddd;
					cursor: pointer;
					background: #a67c52;
					color: white;
					font-size: 11px;
					font-weight: bold;
					text-align: center;
					transition: background-color 0.2s;
				" onmouseover="this.style.background='#8b6640'" onmouseout="this.style.background='#a67c52'">
					New
				</div>
				
				<div id="file-list-empty-state" style="
					padding: 20px;
					text-align: center;
					color: #666;
					font-size: 11px;
					font-style: italic;
				">
					Select a directory to browse files
				</div>
			</div>
			
			<!-- Error/status messages -->
			<div id="explorer-messages" style="
				margin-top: 8px;
				font-size: 10px;
				color: #d32f2f;
				text-align: center;
				display: none;
			"></div>
		</div>
	</div>

	<!-- Save button - positioned to the right of save-box -->
	<div id="save-as-btn" onclick="saveAsSketch()" style="
		position: absolute;
		top: 20px;
		left: 460px;
		background: rgba(223, 223, 223, 0.9);
		border-radius: 10px;
		padding: 15px;
		font-size: 16px;
		font-weight: bold;
		font-family: 'Lucida Grande', 'Segoe UI', sans-serif;
		box-shadow: 0 2px 15px rgba(0,0,0,0.15);
		border: 1px solid rgba(0,0,0,0.1);
		z-index: 10;
		cursor: pointer;
		transition: background-color 0.2s;
		text-align: center;
	" onmouseover="this.style.background='rgba(200, 200, 200, 0.9)'" onmouseout="this.style.background='rgba(223, 223, 223, 0.9)'">
		Save
	</div>

	<!-- Info/help box - bottom left -->
	<div id="guibox">
		<p id="controls-header" onclick="toggleControls()" style="margin: 0; font-weight: bold; cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: space-between;">
			<span>Guide + Color Palette</span>
			<span id="controls-toggle" style="font-size: 14px; font-weight: normal;">‚ñ∫</span>
		</p>
		<div id="controls-content" style="transition: all 0.3s ease-in-out; margin-top: 12px; display: none">
			<!-- Guide content -->
			<div id="guide-content">
				<!-- Content populated dynamically -->
			</div>
			
			<!-- Keyboard Modifier Guide -->
			<div class="keyboard-guide" style="margin: 15px 0; text-align: center; padding: 12px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px;">
				<p style="margin: 0 0 10px 0; font-size: 12px; font-weight: bold;">Keyboard Modifiers (under selection mode):</p>
				<div class="keyboard-layout" style="display: inline-block; font-family: 'Courier New', monospace; font-size: 11px; line-height: 1;">
					<!-- Will be populated dynamically by renderKeyboardGuide() -->
				</div>
			</div>
			
			<!-- Attribution at bottom -->
			<div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd; text-align: center;">
				<span style="font-size: 11px; color: #666; font-style: italic;">
					Forked from <a href="http://madebyevan.com/fsm/" style="color: #666; text-decoration: underline;">Finite State Machine Designer</a>
				</span>
			</div>
		</div>
	</div>
	<script>
// Hidden color picker input for customizing colors
var colorPickerInput = null;
var currentColorKey = null; // Track which color key is being edited

function initializeColorPicker() {
	// Create hidden color picker input
	colorPickerInput = document.createElement('input');
	colorPickerInput.type = 'color';
	colorPickerInput.id = 'color-picker-input';
	colorPickerInput.style.position = 'absolute';
	colorPickerInput.style.opacity = '0';
	colorPickerInput.style.pointerEvents = 'none';
	colorPickerInput.style.width = '0';
	colorPickerInput.style.height = '0';
	document.body.appendChild(colorPickerInput);
	
	// Handle color selection
	colorPickerInput.addEventListener('change', function() {
		if (currentColorKey && typeof updateColorConfig === 'function') {
			var newColor = colorPickerInput.value;
			console.log('üé® Color selected:', currentColorKey, '->', newColor);
			updateColorConfig(currentColorKey, newColor);
		}
		currentColorKey = null;
	});
	
	// Handle cancel
	colorPickerInput.addEventListener('blur', function() {
		currentColorKey = null;
	});
}

function openColorPicker(colorKey) {
	if (!colorPickerInput) {
		initializeColorPicker();
	}
	
	console.log('üé® Opening color picker for key:', colorKey);
	currentColorKey = colorKey;
	
	// Set current color in picker
	if (typeof COLOR_CONFIG !== 'undefined' && COLOR_CONFIG[colorKey]) {
		colorPickerInput.value = COLOR_CONFIG[colorKey];
	}
	
	// Trigger color picker
	colorPickerInput.click();
}

function resetColor(colorKey, event) {
	if (event) {
		event.stopPropagation(); // Prevent opening color picker
	}
	
	console.log('üîÑ Resetting color:', colorKey);
	if (typeof resetColorToDefault === 'function') {
		resetColorToDefault(colorKey);
	}
}

// Generate keyboard guide from COLOR_CONFIG
function generateKeyboardGuide() {
	var guideLine1 = [
		{ colorKey: 'A', color: COLOR_CONFIG['A'] },
		{ colorKey: 'S', color: COLOR_CONFIG['S'] },
		{ colorKey: 'D', color: COLOR_CONFIG['D'] },
		{ colorKey: 'F', color: COLOR_CONFIG['F'] },
		{ colorKey: 'G', color: COLOR_CONFIG['G'] }
	];
	
	var guideLine2 = [
		{ colorKey: 'Z', color: COLOR_CONFIG['Z'] },
		{ colorKey: 'X', color: COLOR_CONFIG['X'] },
		{ colorKey: 'C', color: COLOR_CONFIG['C'] },
		{ colorKey: 'V', color: COLOR_CONFIG['V'] },
		{ colorKey: 'B', color: COLOR_CONFIG['B'] }
	];
	
	return { line1: guideLine1, line2: guideLine2 };
}

// Render keyboard guide dynamically
function renderKeyboardGuide() {
	var container = document.querySelector('.keyboard-layout');
	if (!container) return;
	
	var guide = generateKeyboardGuide();
	var html = '';
	var textColor = '#000'; // Black text with white outline for all keys
	var textShadow = '0 0 3px #fff, 0 0 3px #fff, 0 0 3px #fff, 0 0 3px #fff'; // White glow outline
	
	// Number row (123) for arrow types - not clickable
	html += '<div style="display: flex; gap: 2px; margin-bottom: 4px; justify-content: center;">';
	html += '<div style="width: 28px; height: 28px; border: 1px solid #666; border-radius: 3px; display: flex; align-items: center; justify-content: center; background: #f0f0f0; color: ' + textColor + '; font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; text-shadow: ' + textShadow + ';">1<div style="position: absolute; top: 2px; right: 2px; width: 0; height: 0; border-top: 4px solid transparent; border-bottom: 4px solid transparent; border-left: 6px solid #333;"></div></div>';
	html += '<div style="width: 28px; height: 28px; border: 1px solid #666; border-radius: 3px; display: flex; align-items: center; justify-content: center; background: #f0f0f0; color: ' + textColor + '; font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; text-shadow: ' + textShadow + ';">2<div style="position: absolute; top: 5px; right: 2px; width: 6px; height: 2px; background: #333;"></div><div style="position: absolute; top: 3px; right: 2px; width: 2px; height: 6px; background: #333;"></div></div>';
	html += '<div style="width: 28px; height: 28px; border: 1px solid #666; border-radius: 3px; display: flex; align-items: center; justify-content: center; background: #f0f0f0; color: ' + textColor + '; font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; text-shadow: ' + textShadow + ';">3<div style="position: absolute; top: 4px; right: 2px; width: 8px; height: 2px; background: #333;"></div></div>';
	html += '</div>';
	
	// Top row (ASDFG) - clickable
	html += '<div style="display: flex; gap: 2px; margin-bottom: 2px; justify-content: center;">';
	for (var i = 0; i < guide.line1.length; i++) {
		var item = guide.line1[i];
		var borderColor = '#999';
		html += '<div onclick="openColorPicker(\'' + item.colorKey + '\')" oncontextmenu="resetColor(\'' + item.colorKey + '\', event); return false;" title="Click to change color, right-click to reset" style="width: 28px; height: 28px; border: 1px solid ' + borderColor + '; border-radius: 3px; display: flex; align-items: center; justify-content: center; background: ' + item.color + '; color: ' + textColor + '; font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1); text-shadow: ' + textShadow + '; cursor: pointer; transition: transform 0.1s; position: relative;" onmouseover="this.style.transform=\'scale(1.1)\'" onmouseout="this.style.transform=\'scale(1)\'">' + item.colorKey + '</div>';
	}
	html += '</div>';
	
	// Bottom row (ZXCVB) - clickable
	html += '<div style="display: flex; gap: 2px; justify-content: center;">';
	for (var i = 0; i < guide.line2.length; i++) {
		var item = guide.line2[i];
		html += '<div onclick="openColorPicker(\'' + item.colorKey + '\')" oncontextmenu="resetColor(\'' + item.colorKey + '\', event); return false;" title="Click to change color, right-click to reset" style="width: 28px; height: 28px; border: 1px solid #999; border-radius: 3px; display: flex; align-items: center; justify-content: center; background: ' + item.color + '; color: ' + textColor + '; font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.1); text-shadow: ' + textShadow + '; cursor: pointer; transition: transform 0.1s; position: relative;" onmouseover="this.style.transform=\'scale(1.1)\'" onmouseout="this.style.transform=\'scale(1)\'">' + item.colorKey + '</div>';
	}
	html += '</div>';
	
	container.innerHTML = html;
}

// Toggle guide box visibility

// Populate guide content
function populateGuide() {
	var guideContent = document.getElementById('guide-content');
	if (!guideContent) return;
	
	var html = '';
	
	// New three-state interaction system
	html += '<ul style="margin: 0 0 15px 0; padding-left: 20px; line-height: 16px;">';
	html += '<li><b>Add node:</b> double-click (hold color keys)</li>';
	html += '<li><b>Select object (node or edge):</b> single click</li>';
	html += '<li><b>Edit text:</b> double-click object OR press Enter after selecting an object</li>';
	html += '<li><b>Exit editing:</b> press Escape (steps back through modes) or click away</li>';
	html += '<li><b>Move objects:</b> drag when selected</li>';
	html += '<li><b>Select multiple:</b> drag box around nodes</li>';
	html += '<li><b>Move group:</b> drag any selected node</li>';
	html += '<li><b>Add edge:</b> shift-drag between nodes</li>';
	html += '<li><b>Delete:</b> select + delete key</li>';
	html += '<li><b>Copy/Paste:</b> Cmd+C / Cmd+V (or Ctrl+C / Ctrl+V on Windows/Linux)</li>';
	html += '<li><b>Change object color:</b> select node or edge + press asdfgzxcvb</li>';
	html += '<li><b>Change edge arrowhead:</b> select edge + press 1|2|3</li>';
	html += '<li><b>Subscript text:</b> use underscore (S_0)</li>';
	html += '<li><b>Greek text:</b> use backslash (\\beta)</li>';
	html += '<li><b>Pan canvas:</b> middle mouse + drag OR Cmd+click + drag</li>';
	html += '</ul>';
	
	html += '<div style="margin: 15px 0; padding: 8px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px;">';
	html += '<p style="margin: 0 0 5px 0; font-weight: bold; color: #333; font-size: 12px;">Interaction Modes:</p>';
	html += '<p style="margin: 0; font-size: 11px; line-height: 14px;">Canvas ‚Üí Element selection (click) ‚Üí Label edit (double-click/Enter) ‚Üí back with Escape</p>';
	html += '</div>';
	
	guideContent.innerHTML = html;
}

// Call populateGuide and renderKeyboardGuide when the page loads
document.addEventListener('DOMContentLoaded', function() {
	populateGuide();
	renderKeyboardGuide();
	initializeColorPicker(); // Initialize color picker for customizable colors
});

// =============================================================================
// FILE EXPLORER UI FUNCTIONS
// =============================================================================

/**
 * Update positions of all boxes dynamically
 */
function updateBoxPositions() {
	var dirSelectorBox = document.getElementById('directory-selector-box');
	var separator = document.getElementById('box-separator');
	var saveBox = document.getElementById('save-box');
	var saveBoxExpanded = document.getElementById('save-box-expanded');
	var saveButton = document.getElementById('save-as-btn');
	
	if (!dirSelectorBox) return;
	
	var gap = 10; // Gap between boxes and separator
	var startTop = 20; // Initial top position
	var startLeft = 20; // Initial left position
	
	// Box 1: Directory Selector - always at top left
	dirSelectorBox.style.top = startTop + 'px';
	dirSelectorBox.style.left = startLeft + 'px';
	
	// Separator - between directory selector and save box
	var separatorLeft = startLeft + dirSelectorBox.offsetWidth + gap;
	if (separator) {
		separator.style.top = startTop + 'px';
		separator.style.left = separatorLeft + 'px';
		separator.style.height = dirSelectorBox.offsetHeight + 'px';
	}
	
	// Box 2: Save Box (collapsed or expanded) - to the right of separator
	var separatorWidth = separator ? separator.offsetWidth : 0;
	var saveBoxLeft = separatorLeft + separatorWidth + gap;
	
	// Determine which box is visible and position it
	var activeBox = null;
	if (saveBox && saveBox.style.display !== 'none') {
		activeBox = saveBox;
	} else if (saveBoxExpanded && saveBoxExpanded.style.display !== 'none') {
		activeBox = saveBoxExpanded;
	}
	
	if (activeBox) {
		activeBox.style.top = startTop + 'px';
		activeBox.style.left = saveBoxLeft + 'px';
		
		// Save button - to the right of active save box
		if (saveButton) {
			var saveButtonLeft = saveBoxLeft + activeBox.offsetWidth + gap;
			saveButton.style.top = startTop + 'px';
			saveButton.style.left = saveButtonLeft + 'px';
		}
	}
}

// Legacy function name for backward compatibility
function updateSaveBoxPosition() {
	updateBoxPositions();
}

/**
 * Update directory status display
 */
function updateDirectoryDisplay(directoryName, path) {
	var dirSelectorBox = document.getElementById('directory-selector-box');
	
	if (dirSelectorBox) {
		if (directoryName && path) {
			// Show directory name with trailing slash
			dirSelectorBox.textContent = '/.../' + directoryName + '/';
			dirSelectorBox.title = 'Current directory: ' + path + '\nClick to change directory'; // Tooltip for additional context
		} else {
			dirSelectorBox.textContent = 'Select Directory';
			dirSelectorBox.title = 'Click to select a directory';
		}
	}
	
	// Update box positions after directory button width changes
	setTimeout(updateBoxPositions, 0);
}

/**
 * Choose directory using File System Access API
 */
function chooseSketchDirectory() {
	if (typeof FileExplorerManager !== 'undefined') {
		showExplorerMessage('Selecting directory...', 'info');
		
		FileExplorerManager.chooseDirectory().then(function() {
			var directoryName = FileExplorerManager.getCurrentDirectoryName();
			// Build a path-like display with tilde prefix
			var displayPath = '~/.../' + directoryName;
			updateDirectoryDisplay(directoryName, displayPath);
			updateFileListDisplay();
			updateSaveButtonStates();
			hideExplorerMessage();
			console.log('‚úÖ Directory selected successfully');
		}).catch(function(error) {
			console.error('Failed to choose directory:', error);
			showExplorerMessage('Failed to select directory: ' + error.message, 'error');
		});
	} else {
		showExplorerMessage('File System Access not available', 'error');
	}
}

/**
 * Refresh file list
 */
function refreshFileList() {
	if (typeof FileExplorerManager !== 'undefined' && FileExplorerManager.directoryHandle) {
		showExplorerMessage('Refreshing files...', 'info');
		
		FileExplorerManager.refreshFileList().then(function() {
			updateFileListDisplay();
			hideExplorerMessage();
			console.log('‚úÖ File list refreshed');
		}).catch(function(error) {
			console.error('Failed to refresh file list:', error);
			showExplorerMessage('Failed to refresh files: ' + error.message, 'error');
		});
	}
}

/**
 * Update the file list display
 */
function updateFileListDisplay() {
	var fileList = document.getElementById('file-list');
	var emptyState = document.getElementById('file-list-empty-state');
	
	if (!fileList) return;
	
	// Start with the New button (always present)
	var html = '<div onclick="handleNewSketch()" style="padding: 8px 10px; border-bottom: 1px solid #ddd; cursor: pointer; background: #a67c52; color: white; font-size: 11px; font-weight: bold; text-align: center; transition: background-color 0.2s;" onmouseover="this.style.background=\'#8b6640\'" onmouseout="this.style.background=\'#a67c52\'">New</div>';
	
	if (typeof FileExplorerManager === 'undefined' || !FileExplorerManager.files) {
		// Show empty state after New button
		html += '<div id="file-list-empty-state" style="padding: 20px; text-align: center; color: #666; font-size: 11px; font-style: italic;">Select a directory to browse files</div>';
		fileList.innerHTML = html;
		return;
	}
	
	var files = FileExplorerManager.files;
	
	if (files.length === 0) {
		// Show "no files" message after New button
		html += '<div style="padding: 20px; text-align: center; color: #666; font-size: 11px; font-style: italic;">No .json files found</div>';
		fileList.innerHTML = html;
		return;
	}
	
	// Add file items after New button
	files.forEach(function(file, index) {
		var isSelected = FileExplorerManager.currentFilename === file.name;
		html += '<div class="file-item' + (isSelected ? ' selected' : '') + '" onclick="selectFile(\'' + file.name + '\')">';
		html += '  <span class="file-name">' + file.name + '</span>';
		html += '  <div class="file-actions">';
		html += '    <button class="file-action-btn" onclick="event.stopPropagation(); loadSketchFile(\'' + file.name + '\')" title="Load this file">Import</button>';
		html += '    <button class="file-action-btn file-delete-btn" onclick="event.stopPropagation(); confirmDeleteSketchFile(\'' + file.name + '\')" title="Delete this file">Del</button>';
		html += '  </div>';
		html += '</div>';
	});
	
	fileList.innerHTML = html;
}

/**
 * Select a file (visual selection, not loading)
 */
function selectFile(filename) {
	// Update visual selection
	var fileItems = document.querySelectorAll('.file-item');
	fileItems.forEach(function(item) {
		item.classList.remove('selected');
	});
	
	// Find and select the clicked item
	fileItems.forEach(function(item) {
		var nameSpan = item.querySelector('.file-name');
		if (nameSpan && nameSpan.textContent === filename) {
			item.classList.add('selected');
		}
	});
	
	console.log('üìÑ Selected file:', filename);
}

/**
 * Load a sketch file
 */
function loadSketchFile(filename) {
	if (typeof FileExplorerManager === 'undefined') {
		showExplorerMessage('File System Access not available', 'error');
		return;
	}
	
	showExplorerMessage('Loading ' + filename + '...', 'info');
	
	FileExplorerManager.readFile(filename).then(function(content) {
		try {
			var jsonData = JSON.parse(content);
			
			// Use existing processJSONData function
			if (typeof processJSONData === 'function') {
				processJSONData(jsonData, filename);
				
				// Update current file tracking
				FileExplorerManager.currentFilename = filename;
				updateFileListDisplay();
				updateSaveButtonStates();
				updateImportedFilenameDisplay(filename);
				
				// Update filename input
				var filenameInput = document.getElementById('filenameInput');
				if (filenameInput && filename) {
					var filenameWithoutExtension = filename.replace(/\.json$/, '');
					filenameInput.value = filenameWithoutExtension;
				}
				
				// Update collapsed view
				updateCollapsedFilename(filename);
				
				// Save to localStorage for persistence
				if (localStorage) {
					localStorage['fsm_current_filename'] = filename;
					localStorage['fsm_is_imported'] = 'true';
				}
				
				hideExplorerMessage();
				console.log('‚úÖ Successfully loaded:', filename);
			} else {
				throw new Error('processJSONData function not available');
			}
		} catch (error) {
			console.error('Failed to process file content:', error);
			showExplorerMessage('Failed to load file: ' + error.message, 'error');
		}
	}).catch(function(error) {
		console.error('Failed to read file:', error);
		showExplorerMessage('Failed to read file: ' + error.message, 'error');
	});
}

/**
 * Prompt user to confirm deletion of a sketch file
 */
function confirmDeleteSketchFile(filename) {
    if (!filename) return;
    var confirmed = confirm('WARNING: Delete Sketch File\n\nAre you sure you want to permanently delete "' + filename + '"?\n\nThis action cannot be undone and the file will be removed from your local directory.');
    if (confirmed) {
        deleteSketchFile(filename);
    }
}/**
 * Delete a sketch file from the selected directory (or show error if not available)
 */
function deleteSketchFile(filename) {
	if (typeof FileExplorerManager === 'undefined' || !FileExplorerManager.directoryHandle) {
		showExplorerMessage('File deletion not available: no directory selected', 'error');
		return;
	}

	showExplorerMessage('Deleting ' + filename + '...', 'info');

	FileExplorerManager.deleteFile(filename).then(function() {
		showExplorerMessage('Deleted ' + filename, 'info');
		// Refresh list and UI
		updateFileListDisplay();
		updateSaveButtonStates();
		hideExplorerMessage(1500);
	}).catch(function(error) {
		console.error('Failed to delete file:', error);
		showExplorerMessage('Failed to delete file: ' + error.message, 'error');
	});
}

/**
 * Save As - uses directory if available, falls back to browser download
 */
function saveAsSketch() {
	// Use the custom filename from the input field
	var filename = getCustomFilename();
	
	// If directory is available, save to directory
	if (typeof FileExplorerManager !== 'undefined' && FileExplorerManager.directoryHandle) {
		saveSketchToFile(filename);
	} else {
		// Fall back to browser download to Downloads folder
		console.log('No directory selected, using browser download to Downloads folder');
		if (typeof downloadAsJSON === 'function') {
			downloadAsJSON();
		} else {
			console.error('downloadAsJSON function not available');
			alert('Save function not available. Please check the console for errors.');
		}
	}
}


/**
 * Update opened filename display
 */
function updateOpenedFilename(filename) {
	var openedEl = document.getElementById('opened-filename');
	if (openedEl) {
		if (filename) {
			openedEl.textContent = filename;
			openedEl.style.fontStyle = 'normal';
			openedEl.style.color = '#333';
		} else {
			openedEl.textContent = 'No file loaded';
			openedEl.style.fontStyle = 'italic';
			openedEl.style.color = '#666';
		}
	}

	// Update the filename input when a file is loaded
	var filenameInput = document.getElementById('filenameInput');
	if (filenameInput && filename) {
		// Remove .json extension for display in input
		var filenameWithoutExtension = filename.replace(/\.json$/, '');
		filenameInput.value = filenameWithoutExtension;
	}

	// Also update the header filename display (shown when collapsed)
	var headerFilenameEl = document.getElementById('header-filename');
	if (headerFilenameEl) {
		if (filename) {
			headerFilenameEl.textContent = '[imported: ' + filename + ']';
		} else {
			headerFilenameEl.textContent = '';
		}
	}
}


/**
 * Save sketch to specified file
 */
function saveSketchToFile(filename) {
	showExplorerMessage('Saving ' + filename + '...', 'info');
	
	try {
		// Create JSON data using existing serialization
		var jsonData = createJSONData(); // We'll need to create this function
		var jsonString = JSON.stringify(jsonData, null, 2);
		
		FileExplorerManager.writeFile(filename, jsonString).then(function() {
			// Update current file tracking
			FileExplorerManager.currentFilename = filename;
			updateFileListDisplay();
			updateSaveButtonStates();
			updateOpenedFilename(filename);
			
			hideExplorerMessage();
			console.log('‚úÖ Successfully saved:', filename);
		}).catch(function(error) {
			console.error('Failed to save file:', error);
			showExplorerMessage('Failed to save file: ' + error.message, 'error');
		});
	} catch (error) {
		console.error('Failed to create file content:', error);
		showExplorerMessage('Failed to create file content: ' + error.message, 'error');
	}
}

/**
 * Toggle save box between collapsed and expanded states
 */
function toggleSaveBox() {
	var collapsedBox = document.getElementById('save-box');
	var expandedBox = document.getElementById('save-box-expanded');
	
	if (!collapsedBox || !expandedBox) return;
	
	var isCollapsed = collapsedBox.style.display !== 'none';
	
	if (isCollapsed) {
		// Expand - hide collapsed, show expanded
		collapsedBox.style.display = 'none';
		expandedBox.style.display = 'block';
		console.log('üìÇ Save box expanded');
	} else {
		// Collapse - show collapsed, hide expanded
		collapsedBox.style.display = 'block';
		expandedBox.style.display = 'none';
		console.log('üìÅ Save box collapsed');
	}
	
	// Update box positions after state change
	setTimeout(updateBoxPositions, 0);
}

/**
 * Update collapsed filename display
 */
function updateCollapsedFilename(filename) {
	var collapsedFilename = document.getElementById('collapsed-filename');
	if (collapsedFilename) {
		if (filename) {
			collapsedFilename.textContent = filename;
		} else {
			// If no filename provided, read from input
			var filenameInput = document.getElementById('filenameInput');
			var inputValue = filenameInput ? filenameInput.value.trim() : '';
			collapsedFilename.textContent = (inputValue || 'sketch1') + '.json';
		}
	}
}

/**
 * Sync collapsed filename with input field (called on input change)
 */
function syncCollapsedFilename() {
	var filenameInput = document.getElementById('filenameInput');
	var collapsedFilename = document.getElementById('collapsed-filename');
	
	if (filenameInput && collapsedFilename) {
		var value = filenameInput.value.trim();
		var fullFilename = (value || 'sketch1') + '.json';
		collapsedFilename.textContent = fullFilename;
		
		// Save to localStorage for persistence
		if (localStorage) {
			localStorage['fsm_current_filename'] = fullFilename;
		}
	}
}

/**
 * Update imported filename display indicator
 */
function updateImportedFilenameDisplay(filename) {
	// Element removed from UI, but keep function for compatibility
	// Just update the collapsed view and localStorage
	
	if (filename) {
		// Update collapsed view
		updateCollapsedFilename(filename);
		
		// Save to localStorage for persistence
		if (localStorage) {
			localStorage['fsm_current_filename'] = filename;
			localStorage['fsm_is_imported'] = 'true';
		}
	} else {
		// Reset to default
		updateCollapsedFilename(null);
		
		// Clear imported flag
		if (localStorage) {
			localStorage['fsm_is_imported'] = 'false';
		}
	}
}

/**
 * Handle New Sketch button - clears canvas and resets file tracking
 */
function handleNewSketch() {
	// Call the original clearCanvas function if it exists
	if (typeof clearCanvas === 'function') {
		clearCanvas();
	}
	
	// Clear imported filename display
	updateImportedFilenameDisplay(null);
	
	// Clear file tracking
	if (typeof FileExplorerManager !== 'undefined') {
		FileExplorerManager.currentFilename = null;
	}
	
	// Reset filename input to default
	var filenameInput = document.getElementById('filenameInput');
	if (filenameInput) {
		filenameInput.value = 'sketch1';
	}
	
	// Update collapsed view (will show sketch1.json)
	updateCollapsedFilename(null);
	
	// Save default to localStorage
	if (localStorage) {
		localStorage['fsm_current_filename'] = 'sketch1.json';
		localStorage['fsm_is_imported'] = 'false';
	}
	
	// Update file list to remove selection
	updateFileListDisplay();
	
	console.log('üÜï New sketch created');
}

/**
 * Restore file explorer state from localStorage on page load
 */
function restoreFileExplorerState() {
	if (!localStorage) return;
	
	var filenameToRestore = null;
	var isImported = false;
	
	// Try to get filename from our dedicated storage first
	if (localStorage['fsm_current_filename']) {
		filenameToRestore = localStorage['fsm_current_filename'];
		isImported = localStorage['fsm_is_imported'] === 'true';
	} 
	// Fallback to extracting from main backup
	else if (localStorage['fsm']) {
		try {
			var backup = JSON.parse(localStorage['fsm']);
			if (backup.filename) {
				filenameToRestore = backup.filename;
				isImported = true; // If it's in the backup, it was likely imported
			}
		} catch (e) {
			console.warn('Could not parse localStorage backup for filename restoration');
		}
	}
	
	// Restore the UI if we found a filename
	if (filenameToRestore) {
		console.log('üîÑ Restoring filename:', filenameToRestore);
		
		// Update filename input (remove .json extension)
		var filenameInput = document.getElementById('filenameInput');
		if (filenameInput) {
			var filenameWithoutExtension = filenameToRestore.replace(/\.json$/, '');
			filenameInput.value = filenameWithoutExtension;
		}
		
		// Update collapsed view
		updateCollapsedFilename(filenameToRestore);
		
		// Show imported indicator if it was imported
		if (isImported) {
			updateImportedFilenameDisplay(filenameToRestore);
		}
		
		// Set the current filename in FileExplorerManager to maintain selection state
		if (typeof FileExplorerManager !== 'undefined' && isImported) {
			FileExplorerManager.currentFilename = filenameToRestore;
			console.log('‚úÖ Set FileExplorerManager.currentFilename to:', filenameToRestore);
		}
	} else {
		console.log('üìù No filename to restore, using default');
	}
}

/**
 * Update save button states
 */
function updateSaveButtonStates() {
	var saveAsBtn = document.getElementById('save-as-btn');
	
	// Save button is always enabled - will use directory or fall back to browser download
	if (saveAsBtn) {
		saveAsBtn.disabled = false;
	}
}

/**
 * Show explorer message
 */
function showExplorerMessage(message, type) {
	var messagesEl = document.getElementById('explorer-messages');
	if (messagesEl) {
		messagesEl.textContent = message;
		messagesEl.style.display = 'block';
		messagesEl.style.color = type === 'error' ? '#d32f2f' : '#666';
	}
}

/**
 * Hide explorer message
 */
function hideExplorerMessage() {
	var messagesEl = document.getElementById('explorer-messages');
	if (messagesEl) {
		messagesEl.style.display = 'none';
	}
}

/**
 * Create JSON data for saving (extract from existing downloadAsJSON function)
 */
function createJSONData() {
	// This duplicates logic from downloadAsJSON - we'll extract it into a shared function
	var nodeIdMap = new Map();
	var jsonNodes = [];
	
	// Serialize nodes with unique IDs
	for (var i = 0; i < nodes.length; i++) {
		var node = nodes[i];
		var nodeId = i;
		nodeIdMap.set(node, nodeId);
		
		jsonNodes.push({
			id: nodeId,
			x: node.x,
			y: node.y, 
			text: node.text,
			colorKey: node.colorKey || 'A'
		});
	}
	
	// Serialize links with node ID references
	var jsonLinks = [];
	for (var i = 0; i < links.length; i++) {
		var link = links[i];
		var linkData = {
			text: link.text,
			arrowType: link.arrowType || 'arrow',  // Include arrow type
			colorKey: link.colorKey || 'A'            // Include link colorKey
		};
		
		// Handle different link types - simplified for this example
		if (link.constructor.name === 'SelfLink') {
			linkData.type = 'SelfLink';
			linkData.node = nodeIdMap.get(link.node);
			linkData.anchorAngle = link.anchorAngle;
		} else if (link.constructor.name === 'StartLink') {
			linkData.type = 'StartLink';
			linkData.node = nodeIdMap.get(link.node);
			linkData.deltaX = link.deltaX;
			linkData.deltaY = link.deltaY;
		} else if (link.constructor.name === 'Link') {
			linkData.type = 'Link';
			linkData.nodeA = nodeIdMap.get(link.nodeA);
			linkData.nodeB = nodeIdMap.get(link.nodeB);
			linkData.text = link.text;
			linkData.lineAngleAdjust = link.lineAngleAdjust;
			linkData.parallelPart = link.parallelPart;
			linkData.perpendicularPart = link.perpendicularPart;
		}
		
		jsonLinks.push(linkData);
	}
	
	// Serialize legend descriptions
	var jsonLegend = {};
	if (typeof legendEntries !== 'undefined') {
		for (var key in legendEntries) {
			if (legendEntries[key].description && legendEntries[key].description.trim() !== '') {
				jsonLegend[key] = legendEntries[key].description;
			}
		}
	}

	return {
		version: '1.0',
		created: new Date().toISOString(),
		COLOR_CONFIG: typeof COLOR_CONFIG !== 'undefined' ? COLOR_CONFIG : {},  // Include color palette
		canvas: {
			width: typeof canvas !== 'undefined' ? canvas.width : 800,
			height: typeof canvas !== 'undefined' ? canvas.height : 600
		},
		nodes: jsonNodes,
		links: jsonLinks,
		legend: jsonLegend
	};
}

// Initialize file explorer when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
	// Check if File System Access API is supported and show/hide explorer accordingly
	if ('showDirectoryPicker' in window) {
		// Show directory selector box
		var dirSelectorBox = document.getElementById('directory-selector-box');
		
		if (dirSelectorBox) dirSelectorBox.style.display = 'block';
		
		// Set initial positions
		setTimeout(updateBoxPositions, 0);
		
		updateSaveButtonStates();
		
		// Restore filename state from localStorage
		restoreFileExplorerState();
		
		console.log('üìÇ File Explorer UI initialized (2-box layout with integrated file list)');
	} else {
		console.log('‚ö†Ô∏è File System Access API not supported - File Explorer hidden');
	}
	
	// Debug localStorage backup
	console.log('üîç Checking localStorage backup...');
	if (localStorage && localStorage['fsm']) {
		try {
			var backup = JSON.parse(localStorage['fsm']);
			console.log('üì¶ Backup found:', backup.nodes.length, 'nodes,', backup.links.length, 'links');
			console.log('üì¶ Backup data:', backup);
		} catch (e) {
			console.error('‚ùå Failed to parse backup:', e);
		}
	} else {
		console.log('‚ö†Ô∏è No backup found in localStorage');
	}
});
	</script>
</body></html>
